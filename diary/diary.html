<!DOCTYPE html>
{% load static %}
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="diary_style.css" />
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  </head>

  <body style="margin: 0;">
    <div class="div-wrapper">
      <div class="div">
        <div class="div-2">
          <!-- ì˜¤ëŠ˜ì˜ í™œë™ -->
          <div class="activity_div">
            <div class="item_rectangle">
              <div class="item_text">ì˜¤ëŠ˜ì˜ í™œë™</div>
            </div>
            <div class="today_activity">
              <div class="activity_item">
                <label for="rest">
                  <input type="checkbox" name="rating" class="activity" id="rest" value="rest" />
                  <img class="rest_img" src="../icon/íœ´ì‹.png" />
                  <div class="rest_text">íœ´ì‹</div>
                </label>
              </div>
              
              <div class="activity_item">
                <label for="health">
                  <input type="checkbox" name="rating" class="activity" id="health" value="health" />
                  <img class="health_img" src="../icon/ìš´ë™.png" />
                  <div class="health_text">ìš´ë™</div>
                </label>
              </div>
            
              <div class="activity_item">
                <label for="study">
                  <input type="checkbox" name="rating" class="activity" id="study" value="study" />
                  <img class="study_img" src="../icon/ê³µë¶€.png" />
                  <div class="study_text">ê³µë¶€</div>
                </label>
              </div>
            
              <div class="activity_item">
                <label for="work">
                  <input type="checkbox" name="rating" class="activity" id="work" value="work" />
                  <img class="work_img" src="../icon/ì¼.png" />
                  <div class="work_text">ì¼</div>
                </label>
              </div>
            
              <div class="activity_item">
                <label for="shopping">
                  <input type="checkbox" name="rating" class="activity" id="shopping" value="shopping" />
                  <img class="shopping_img" src="../icon/ì‡¼í•‘.png" />
                  <div class="shopping_text">ì‡¼í•‘</div>
                </label>
              </div>
            </div>
          </div>

          <!-- ì˜¤ëŠ˜ì˜ ë‚ ì”¨ -->
          <div class="weather_div">
            <div class="item_rectangle">
              <div class="item_text">ì˜¤ëŠ˜ì˜ ë‚ ì”¨</div>
            </div>
            <div class="today_weather">
              <!-- First Row -->
              <div class="weather_row">
                <div class="weather_item">
                  <label for="sunny">
                    <input type="checkbox" name="weather" class="weather" id="sunny" value="sunny" />
                    <img class="sunny_img" src="../icon/ë§‘ìŒ.png" />
                  </label>
                  <div class="weather_text">ë§‘ìŒ</div>
                </div>
                <div class="weather_item">
                  <label for="íë¦¼">
                    <input type="checkbox" name="weather" class="weather" id="íë¦¼" value="íë¦¼" />
                    <img class="cloudy_img" src="../icon/íë¦¼.png" />
                  </label>
                  <div class="weather_text">íë¦¼</div>
                </div>
                <div class="weather_item">
                  <label for="ë¹„">
                    <input type="checkbox" name="weather" class="weather" id="ë¹„" value="ë¹„" />
                    <img class="rainy_img" src="../icon/ë¹„.png" />
                  </label>
                  <div class="weather_text">ë¹„</div>
                </div>
                <div class="weather_item">
                  <label for="ëˆˆ">
                    <input type="checkbox" name="weather" class="weather" id="ëˆˆ" value="ëˆˆ" />
                    <img class="snow_img" src="../icon/ëˆˆ.png" />
                  </label>
                  <div class="weather_text">ëˆˆ</div>
                </div>
              </div>
          
              <!-- Second Row -->
              <div class="weather_row">
                <div class="weather_item">
                  <label for="í­í’">
                    <input type="checkbox" name="weather" class="weather" id="í­í’" value="í­í’" />
                    <img class="stormy_img" src="../icon/í­í’.png" />
                  </label>
                  <div class="weather_text">í­í’</div>
                </div>
                <div class="weather_item">
                  <label for="ë°”ëŒ">
                    <input type="checkbox" name="weather" class="weather" id="ë°”ëŒ" value="ë°”ëŒ" />
                    <img class="windy_img" src="../icon/ë°”ëŒ.png" />
                  </label>
                  <div class="weather_text">ë°”ëŒ</div>
                </div>
                <div class="weather_item">
                  <label for="ë”ì›€">
                    <input type="checkbox" name="weather" class="weather" id="ë”ì›€" value="ë”ì›€" />
                    <img class="hot_img" src="../icon/ë”ì›€.png" />
                  </label>
                  <div class="weather_text">ë”ì›€</div>
                </div>
                <div class="weather_item">
                  <label for="ì¶”ì›€">
                    <input type="checkbox" name="weather" class="weather" id="ì¶”ì›€" value="ì¶”ì›€" />
                    <img class="cold_img" src="../icon/ì¶”ì›€.png" />
                  </label>
                  <div class="weather_text">ì¶”ì›€</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ì˜¤ëŠ˜ì˜ ì¼ê¸° -->
          <div class="diary_div">
            <div class="item_rectangle">
              <div class="item_text">ì˜¤ëŠ˜ì˜ ì¼ê¸°</div>
            </div>
            <div class="today_diary">
              <div class="diary_text" contenteditable="true" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this)">
                ë‚´ìš© ì…ë ¥í•´ì£¼ì„¸ìš”</div>
            </div>
          </div>
        </div>

        <!-- ì™„ë£Œ ë²„íŠ¼ -->
        <div class="Done_group">
          <div class="Done_rectangle" id="saveButton" style="cursor: pointer;">
            <div class="Done_text">ì™„&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ë£Œ</div>
          </div>
        </div>

        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <div class="upper_icon">
          <div class="diary_date"></div>
          <img class="back_img" src="../icon/ë’¤ë¡œê°€ê¸° ë²„íŠ¼.png" style="cursor: pointer;" onclick="confirmExit()" />
          <div class="line"></div>
        </div>
      </div>
    </div>

    <script>
      const checkboxes = document.querySelectorAll('input[type="checkbox"].activity');

      checkboxes.forEach((checkbox) => {
          checkbox.addEventListener('change', () => {
              const checkedCount = document.querySelectorAll('input[type="checkbox"].activity:checked').length;
              if (checkedCount > 2) {
                  checkbox.checked = false; // Uncheck the current box if the limit is exceeded
                  swal({
                    icon: "error",
                    content: {
                        element: "p",
                        attributes: {
                            innerHTML: "ìµœëŒ€ ë‘ ê°œë§Œ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”",
                        }
                    }
                });
              }
          });
      });


      const checkboxes_weather = document.querySelectorAll('input[type="checkbox"].weather');

      checkboxes_weather.forEach((checkbox) => {
          checkbox.addEventListener('change', () => {
              // Count how many checkboxes are currently checked
              const checkedCount_weather = document.querySelectorAll('input[type="checkbox"].weather:checked').length;
          
              // If more than 2 checkboxes are selected, uncheck the latest one and show an alert
              if (checkedCount_weather > 2) {
                  checkbox.checked = false; // Uncheck the current checkbox
                  swal({
                    icon: "error",
                    content: {
                        element: "p",
                        attributes: {
                            innerHTML: "ìµœëŒ€ ë‘ ê°œë§Œ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”",
                        }
                    }
                });
              }
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const month = params.get("month");
        const day = params.get("day");
        let dayOfWeek = params.get("dayofweek");
        let dayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
        dayOfWeek = dayNames[dayOfWeek];
    
        if (month && day && dayOfWeek) {
            const dateText = `${month}ì›” ${day}ì¼ (${dayOfWeek})`;
            const view9Element = document.querySelector(".upper_icon .diary_date");
            if (view9Element) {
              view9Element.textContent = dateText;
            } else {
              console.error("diary_date not found");
            }
          } else {
            console.error("Date parameters are missing in the URL");
          }
        });
      
      document.getElementById('saveButton').addEventListener('click', function() {
        // ì„ íƒëœ "ì˜¤ëŠ˜ì˜  í™œë™"
        const selectedActivities = Array.from(document.querySelectorAll('input[type="checkbox"].activity:checked'))
          .map((checkbox) => checkbox.value);
        
        // ì„ íƒëœ "ì˜¤ëŠ˜ì˜  ë‚ ì”¨"
        const selectedWeather = Array.from(document.querySelectorAll('input[type="checkbox"].weather:checked'))
          .map((checkbox) => checkbox.value);
      
        // ì‘ì„±ëœ "ì˜¤ëŠ˜ì˜ ì¼ê¸°"
        const diaryContent = document.querySelector('.diary_text').textContent.trim();
      
        // Prepare data for Django
        const data = {
          activities: selectedActivities,
          weather: selectedWeather,
          diary: diaryContent,
        };
      
        // Fetch ì´ìš©í•´ì„œ ì¥ê³ ì— data ì˜®ê¸°ê¸°
        // '/save-diary/'ëŠ” Djangoì˜ url
        fetch('/save-diary/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // POST ìš”ì²­ì— ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ì—ì„œ ì˜¨ ê²ƒì„ì„ ë³´ì¥í•´ì£¼ëŠ” token
          },
          body: JSON.stringify(data) // dataê°€JSONí˜•ì‹ìœ¼ë¡œ ë³€í™˜ë˜ì–´ Django ì„œë²„ë¡œ ì „ì†¡
        })
        .then(response => response.json()) // Djangoì—ì„œ ìš”ì²­ì„ ì²˜ë¦¬í•œ í›„ JSON ì‘ë‹µ ë³´ë‚´ë„ë¡ ì„¤ì •
        .then(data => {
          if (data.success) {
            alert('Data saved successfully!');
          } else {
            alert('Failed to save data.');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      });

      function confirmExit() {
        swal({
            title: "í¸ì§‘í•œ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ì–´ìš”.",
            text: "ì •ë§ ë‚˜ê°€ì‹œëŠ” ê±°ì˜ˆìš”? ğŸ¥¹",
            icon: "warning",
            buttons: {
                cancel: "ì·¨ì†Œ",
                confirm: {
                    text: "í™•ì¸",
                    value: true,
                    visible: true,
                    className: "btn-danger",
                    closeModal: true
                }
            }
        }).then((isConfirm) => {
            if (isConfirm) {
                const params = new URLSearchParams(window.location.search);
                const year = params.get('year');
                const month = params.get('month');
                const day = params.get('day');
                window.location.href = `../main/main.html?year=${year}&month=${month}&day=${day}`;
            }
        });
      }

    function clearPlaceholder(element) {
        if (element.textContent === "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”") {
            element.textContent = ""; // placeholder ì œê±°
        }
    }
    
    function restorePlaceholder(element) {
        if (element.textContent.trim() === "") {
            element.textContent = "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"; // placeholder ë³µì›
        }
    }

    </script>
  </body>
</html>