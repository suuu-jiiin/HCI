<!DOCTYPE html>
{% load static %}
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="diary_style.css" />
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  </head>

  <body style="margin: 0;">
    <div class="div-wrapper">
      <div class="div">
        <div class="div-2">
          <!-- 오늘의 활동 -->
          <div class="activity_div">
            <div class="item_rectangle">
              <div class="item_text">오늘의 활동</div>
            </div>
            <div class="today_activity">
              <div class="activity_item">
                <label for="rest">
                  <input type="checkbox" name="rating" class="activity" id="rest" value="rest" />
                  <img class="rest_img" src="../icon/휴식.png" />
                  <div class="rest_text">휴식</div>
                </label>
              </div>
              
              <div class="activity_item">
                <label for="health">
                  <input type="checkbox" name="rating" class="activity" id="health" value="health" />
                  <img class="health_img" src="../icon/운동.png" />
                  <div class="health_text">운동</div>
                </label>
              </div>
            
              <div class="activity_item">
                <label for="study">
                  <input type="checkbox" name="rating" class="activity" id="study" value="study" />
                  <img class="study_img" src="../icon/공부.png" />
                  <div class="study_text">공부</div>
                </label>
              </div>
            
              <div class="activity_item">
                <label for="work">
                  <input type="checkbox" name="rating" class="activity" id="work" value="work" />
                  <img class="work_img" src="../icon/일.png" />
                  <div class="work_text">일</div>
                </label>
              </div>
            
              <div class="activity_item">
                <label for="shopping">
                  <input type="checkbox" name="rating" class="activity" id="shopping" value="shopping" />
                  <img class="shopping_img" src="../icon/쇼핑.png" />
                  <div class="shopping_text">쇼핑</div>
                </label>
              </div>
            </div>
          </div>

          <!-- 오늘의 날씨 -->
          <div class="weather_div">
            <div class="item_rectangle">
              <div class="item_text">오늘의 날씨</div>
            </div>
            <div class="today_weather">
              <!-- First Row -->
              <div class="weather_row">
                <div class="weather_item">
                  <label for="sunny">
                    <input type="checkbox" name="weather" class="weather" id="sunny" value="sunny" />
                    <img class="sunny_img" src="../icon/맑음.png" />
                  </label>
                  <div class="weather_text">맑음</div>
                </div>
                <div class="weather_item">
                  <label for="흐림">
                    <input type="checkbox" name="weather" class="weather" id="흐림" value="흐림" />
                    <img class="cloudy_img" src="../icon/흐림.png" />
                  </label>
                  <div class="weather_text">흐림</div>
                </div>
                <div class="weather_item">
                  <label for="비">
                    <input type="checkbox" name="weather" class="weather" id="비" value="비" />
                    <img class="rainy_img" src="../icon/비.png" />
                  </label>
                  <div class="weather_text">비</div>
                </div>
                <div class="weather_item">
                  <label for="눈">
                    <input type="checkbox" name="weather" class="weather" id="눈" value="눈" />
                    <img class="snow_img" src="../icon/눈.png" />
                  </label>
                  <div class="weather_text">눈</div>
                </div>
              </div>
          
              <!-- Second Row -->
              <div class="weather_row">
                <div class="weather_item">
                  <label for="폭풍">
                    <input type="checkbox" name="weather" class="weather" id="폭풍" value="폭풍" />
                    <img class="stormy_img" src="../icon/폭풍.png" />
                  </label>
                  <div class="weather_text">폭풍</div>
                </div>
                <div class="weather_item">
                  <label for="바람">
                    <input type="checkbox" name="weather" class="weather" id="바람" value="바람" />
                    <img class="windy_img" src="../icon/바람.png" />
                  </label>
                  <div class="weather_text">바람</div>
                </div>
                <div class="weather_item">
                  <label for="더움">
                    <input type="checkbox" name="weather" class="weather" id="더움" value="더움" />
                    <img class="hot_img" src="../icon/더움.png" />
                  </label>
                  <div class="weather_text">더움</div>
                </div>
                <div class="weather_item">
                  <label for="추움">
                    <input type="checkbox" name="weather" class="weather" id="추움" value="추움" />
                    <img class="cold_img" src="../icon/추움.png" />
                  </label>
                  <div class="weather_text">추움</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 오늘의 일기 -->
          <div class="diary_div">
            <div class="item_rectangle">
              <div class="item_text">오늘의 일기</div>
            </div>
            <div class="today_diary">
              <div class="diary_text" contenteditable="true" onfocus="clearPlaceholder(this)" onblur="restorePlaceholder(this)">
                내용 입력해주세요</div>
            </div>
          </div>
        </div>

        <!-- 완료 버튼 -->
        <div class="Done_group">
          <div class="Done_rectangle" id="saveButton" style="cursor: pointer;">
            <div class="Done_text">완&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 료</div>
          </div>
        </div>

        <!-- 뒤로가기 버튼 -->
        <div class="upper_icon">
          <div class="diary_date"></div>
          <img class="back_img" src="../icon/뒤로가기 버튼.png" style="cursor: pointer;" onclick="confirmExit()" />
          <div class="line"></div>
        </div>
      </div>
    </div>

    <script>
      const checkboxes = document.querySelectorAll('input[type="checkbox"].activity');

      checkboxes.forEach((checkbox) => {
          checkbox.addEventListener('change', () => {
              const checkedCount = document.querySelectorAll('input[type="checkbox"].activity:checked').length;
              if (checkedCount > 2) {
                  checkbox.checked = false; // Uncheck the current box if the limit is exceeded
                  swal({
                    icon: "error",
                    content: {
                        element: "p",
                        attributes: {
                            innerHTML: "최대 두 개만 선택할 수 있어요",
                        }
                    }
                });
              }
          });
      });


      const checkboxes_weather = document.querySelectorAll('input[type="checkbox"].weather');

      checkboxes_weather.forEach((checkbox) => {
          checkbox.addEventListener('change', () => {
              // Count how many checkboxes are currently checked
              const checkedCount_weather = document.querySelectorAll('input[type="checkbox"].weather:checked').length;
          
              // If more than 2 checkboxes are selected, uncheck the latest one and show an alert
              if (checkedCount_weather > 2) {
                  checkbox.checked = false; // Uncheck the current checkbox
                  swal({
                    icon: "error",
                    content: {
                        element: "p",
                        attributes: {
                            innerHTML: "최대 두 개만 선택할 수 있어요",
                        }
                    }
                });
              }
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const month = params.get("month");
        const day = params.get("day");
        let dayOfWeek = params.get("dayofweek");
        let dayNames = ["일", "월", "화", "수", "목", "금", "토"];
        dayOfWeek = dayNames[dayOfWeek];
    
        if (month && day && dayOfWeek) {
            const dateText = `${month}월 ${day}일 (${dayOfWeek})`;
            const view9Element = document.querySelector(".upper_icon .diary_date");
            if (view9Element) {
              view9Element.textContent = dateText;
            } else {
              console.error("diary_date not found");
            }
          } else {
            console.error("Date parameters are missing in the URL");
          }
        });
      
      document.getElementById('saveButton').addEventListener('click', function() {
        // 선택된 "오늘의  활동"
        const selectedActivities = Array.from(document.querySelectorAll('input[type="checkbox"].activity:checked'))
          .map((checkbox) => checkbox.value);
        
        // 선택된 "오늘의  날씨"
        const selectedWeather = Array.from(document.querySelectorAll('input[type="checkbox"].weather:checked'))
          .map((checkbox) => checkbox.value);
      
        // 작성된 "오늘의 일기"
        const diaryContent = document.querySelector('.diary_text').textContent.trim();
      
        // Prepare data for Django
        const data = {
          activities: selectedActivities,
          weather: selectedWeather,
          diary: diaryContent,
        };
      
        // Fetch 이용해서 장고에 data 옮기기
        // '/save-diary/'는 Django의 url
        fetch('/save-diary/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // POST 요청에 신뢰할 수 있는 출처에서 온 것임을 보장해주는 token
          },
          body: JSON.stringify(data) // data가JSON형식으로 변환되어 Django 서버로 전송
        })
        .then(response => response.json()) // Django에서 요청을 처리한 후 JSON 응답 보내도록 설정
        .then(data => {
          if (data.success) {
            alert('Data saved successfully!');
          } else {
            alert('Failed to save data.');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      });

      function confirmExit() {
        swal({
            title: "편집한 내용이 저장되지 않았어요.",
            text: "정말 나가시는 거예요? 🥹",
            icon: "warning",
            buttons: {
                cancel: "취소",
                confirm: {
                    text: "확인",
                    value: true,
                    visible: true,
                    className: "btn-danger",
                    closeModal: true
                }
            }
        }).then((isConfirm) => {
            if (isConfirm) {
                const params = new URLSearchParams(window.location.search);
                const year = params.get('year');
                const month = params.get('month');
                const day = params.get('day');
                window.location.href = `../main/main.html?year=${year}&month=${month}&day=${day}`;
            }
        });
      }

    function clearPlaceholder(element) {
        if (element.textContent === "내용을 입력해주세요") {
            element.textContent = ""; // placeholder 제거
        }
    }
    
    function restorePlaceholder(element) {
        if (element.textContent.trim() === "") {
            element.textContent = "내용을 입력해주세요"; // placeholder 복원
        }
    }

    </script>
  </body>
</html>